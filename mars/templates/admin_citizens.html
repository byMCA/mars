{% extends "layout.html" %}

{% block content %}
<div class="min-h-screen bg-black p-6 lg:p-12 font-sans relative overflow-hidden">
    
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-900/10 rounded-full blur-[100px] pointer-events-none"></div>

    <div class="max-w-7xl mx-auto relative z-10">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-white/10 pb-4 gap-4">
            <div>
                <a href="{{ url_for('admin_panel') }}" class="text-[10px] text-gray-500 hover:text-white mb-2 block">&larr; RETURN TO CONTROL PANEL</a>
                <h1 class="text-3xl font-bold text-white uppercase tracking-widest flex items-center gap-4">
                    <span class="w-2 h-10 bg-blue-500 animate-pulse"></span>
                    CITIZEN DATABASE
                </h1>
                <p class="text-[10px] text-blue-400 font-mono mt-2">MARS POPULATION REGISTRY // ACCESS LEVEL: OMEGA</p>
            </div>
            
            <form action="{{ url_for('admin_citizens') }}" method="GET" class="flex w-full md:w-auto">
                <input type="text" name="q" value="{{ search_query if search_query else '' }}" 
                       placeholder="CODE NAME / NAME / ID SEARCH..." 
                       class="bg-black border border-gray-700 text-white p-3 text-xs w-full md:w-64 focus:border-blue-500 outline-none uppercase font-mono">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 font-bold text-xs hover:bg-blue-500">SEARCH</button>
            </form>
        </div>

        <div class="glass-panel overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-white/5 text-[10px] text-gray-400 uppercase tracking-widest border-b border-white/10">
                        <th class="p-4">IDENTITY</th>
                        <th class="p-4">RANK (TIER)</th>
                        <th class="p-4">STATUS</th>
                        <th class="p-4">ORIGIN</th>
                        <th class="p-4 text-right">ACTIONS</th>
                    </tr>
                </thead>
                <tbody class="text-sm font-mono text-gray-300">
                    {% for user in citizens %}
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors group">
                        
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <img src="{{ url_for('static', filename='profile_pics/' + user.image_file) }}" class="w-10 h-10 rounded object-cover border border-gray-600">
                                <div>
                                    <div class="font-bold text-white">{{ user.username }}</div>
                                    <div class="text-[10px] text-gray-500">{{ user.full_name }}</div>
                                    <div class="text-[9px] text-blue-500">{{ user.citizenship_id }}</div>
                                </div>
                            </div>
                        </td>

                        <td class="p-4">
                            <form action="{{ url_for('update_rank') }}" method="POST" class="flex items-center gap-2">
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <input type="hidden" name="redirect_to" value="citizens"> <select name="new_tier" onchange="this.form.submit()" 
                                        class="bg-black border border-gray-800 text-[10px] p-1 w-32 outline-none focus:border-blue-500 cursor-pointer
                                               {% if user.tier >= 19 %}text-purple-400 border-purple-900{% elif user.tier >= 9 %}text-red-400 border-red-900{% else %}text-gray-300{% endif %}">
                                    {% for i in range(21) %}
                                        <option value="{{ i }}" {% if user.tier == i %}selected{% endif %}>
                                            Tier {{ i }} - {{ tier_names[i] }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>

                        <td class="p-4">
                            {% if user.status == 'BANNED' %}
                                <span class="bg-red-900/50 text-red-500 text-[10px] px-2 py-1 rounded border border-red-500/30">EXILED (BANNED)</span>
                            {% else %}
                                <span class="bg-green-900/50 text-green-500 text-[10px] px-2 py-1 rounded border border-green-500/30">ACTIVE</span>
                            {% endif %}
                        </td>

                        <td class="p-4 text-xs">{{ user.origin }}</td>

                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="openMessageModal('{{ user.id }}', '{{ user.username }}')" 
                                        class="p-2 border border-gray-700 hover:border-white hover:bg-white hover:text-black transition-colors" title="Send Message">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                                </button>

                                {% if user.status == 'BANNED' %}
                                    <a href="{{ url_for('unban_user', user_id=user.id) }}" class="p-2 border border-green-900 text-green-500 hover:bg-green-500 hover:text-black transition-colors" title="Lift Ban">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    </a>
                                {% else %}
                                    {% if user.tier < 20 %}
                                    <a href="{{ url_for('ban_user', user_id=user.id) }}" onclick="return confirm('Are you sure you want to exile this citizen?')" 
                                       class="p-2 border border-red-900 text-red-500 hover:bg-red-500 hover:text-white transition-colors" title="Send to Exile (Ban)">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                                    </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not citizens %}
        <div class="text-center py-12 border border-dashed border-gray-800 text-gray-500 text-xs">
            NO CITIZENS FOUND MEETING THE SEARCH CRITERIA.
        </div>
        {% endif %}

    </div>
</div>

<div id="messageModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-[#0a0a0a] border border-blue-900/50 p-6 max-w-md w-full relative">
        <h3 class="text-blue-500 font-bold mb-4 uppercase tracking-widest">SECURE COMMUNICATION</h3>
        <p class="text-[10px] text-gray-400 mb-4">RECIPIENT: <span id="modalUsername" class="text-white font-bold"></span></p>
        
        <form action="{{ url_for('message_user') }}" method="POST">
            <input type="hidden" name="user_id" id="modalUserId">
            <textarea name="message" rows="4" required placeholder="Enter your message here..." 
                      class="w-full bg-black border border-gray-800 text-white p-3 text-sm focus:border-blue-500 outline-none mb-4 font-mono"></textarea>
            
            <div class="flex justify-end gap-2">
                <button type="button" onclick="document.getElementById('messageModal').classList.add('hidden')" 
                        class="px-4 py-2 border border-gray-700 text-gray-400 text-xs hover:text-white">CANCEL</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-bold text-xs hover:bg-blue-500">SEND</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openMessageModal(id, username) {
        document.getElementById('modalUserId').value = id;
        document.getElementById('modalUsername').innerText = username;
        document.getElementById('messageModal').classList.remove('hidden');
    }
</script>
{% endblock %}